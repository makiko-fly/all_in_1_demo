<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Stock Book</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .info-box {
            width: 100%;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9em;
            line-height: 1.5;
            color: #333;
            position: relative;
            margin-bottom: 20px;
        }

        .info-header {
            padding: 12px 20px;
            background-color: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #eee;
        }

        .info-header:hover {
            background-color: #f0f1f2;
        }

        .info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #fff;
        }

        .info-content.show {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }

        .info-content-inner {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .info-content p {
            margin: 0;
            padding: 0;
            white-space: pre-line;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title-section {
            display: flex;
            align-items: baseline;
            gap: 20px;
        }

        .status-info {
            font-size: 0.9em;
            color: #666;
        }

        .book-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 0.9em;
            table-layout: fixed;
        }

        .book-table th, .book-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .book-table th {
            background-color: #4CAF50;
            color: white;
        }

        .book-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Column widths */
        .book-table th:nth-child(1) { width: 8%; }   /* Symbol */
        .book-table th:nth-child(2) { width: 15%; }  /* DateTime */
        .book-table th:nth-child(3) { width: 7%; }   /* Bid Price */
        .book-table th:nth-child(4) { width: 7%; }   /* Bid Size */
        .book-table th:nth-child(5) { width: 7%; }   /* Ask Price */
        .book-table th:nth-child(6) { width: 7%; }   /* Ask Size */
        .book-table th:nth-child(7) { width: 15%; }  /* Hostname */
        .book-table th:nth-child(8) { width: 15%; }  /* Read From */

        .status {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            display: none;
            color: #2196F3;
        }

        .error {
            color: #f44336;
        }

        @media (max-width: 768px) {
            .book-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="info-box">
        <div class="info-header">
            <span>Demo 说明</span>
            <span class="toggle-icon">▼</span>
        </div>
        <div class="info-content">
            <div class="info-content-inner">
                <p>前端水平一般，所以这个页面做得比较简单，还请见谅。

                    这个小的 demo 项目展示的是 5 支股票的实时 book 快照，数据源来自 alltick 网站。该网站只提供了 book 的 tick data，如果有 order 或者 trade 的话就能更好展示了。
                    我使用 websocket 接入对方的服务，然后存储到 redis 的 stream 中（生产环境建议用 Kafka），然后又起了一个服务来读取 redis 数据并插入 clickhouse 集群。
                    然后又起了个 API 服务来拉取最新的 ClickHouse 数据展示到当前页面。

                    我在 aws 上搭建了一个 k8s 集群，配置了常见的一些 resource, 包括 nodegroup, role, storage, deployment, service, ingress, domain, https 等。
                    当前大部分的服务都运行在了这个 k8s 集群上，只有当前的 websocket, redis 尚未部署，这一两天就会改好放上去。

                    又在这个 k8s 上部署了一个 clickhouse 集群 (2 shards, 2 replicas)。用的是 altinity 的 ClickHouseInstallation,
                    这个方法只需很少的步骤便可部署一个安全，高可用，易扩展的 clickhouse 集群。
                    页面上的 InsertedFrom 是指从哪台机器进行的插入，Read From 是指从哪个 Shard 哪个 Replica 读取的。下面的表则显示了两个 Shard 的统计数据。
                    为了展示客户端能访问到集群的不同 Shard 或者不同 Replica，还是按 rand 来选 Shard，生产环境 Shard 方法需要按照业务需求来做定义。
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="title-section">
                <h1>Chinese Stock Book</h1>
                <span class="status-info">
                    <span class="last-update"></span>
                    <span class="refresh-countdown"></span>
                </span>
            </div>
        </div>

        <table class="book-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>DateTime</th>
                    <th>Bid Size1</th>
                    <th>Bid Price1</th>
                    <th>Ask Price1</th>
                    <th>Ask Size1</th>
                    <th>Inserted From</th>
                    <th>Read From</th>
                </tr>
            </thead>
            <tbody id="bookBody"></tbody>
        </table>

        <table class="book-table" style="margin-top: 20px;">
            <thead>
                <tr>
                    <th>Server</th>
                    <th>Row Count</th>
                    <th>Min Date</th>
                    <th>Max Date</th>
                </tr>
            </thead>
            <tbody id="statsBody"></tbody>
        </table>

        <div class="status">
            <span class="loading">Loading...</span>
            <span class="error"></span>
        </div>


    </div>

    <script>
        let autoRefreshInterval;
        let countdownInterval;
        const REFRESH_INTERVAL = 10;

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3,
                hour12: false,
                timeZone: 'Asia/Shanghai'
            });
        }

        function formatNumber(number) {
            if (number === undefined || number === null || isNaN(number)) {
                return '-';
            }
            return number.toString();
        }

        function updateCountdown(secondsLeft) {
            const countdownEl = document.querySelector('.refresh-countdown');
            if (countdownEl) {
                countdownEl.textContent = ` (Refresh in ${secondsLeft}s)`;
            }
        }

        function startCountdown() {
            let secondsLeft = REFRESH_INTERVAL;
            updateCountdown(secondsLeft);

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                secondsLeft -= 1;
                updateCountdown(secondsLeft);
                if (secondsLeft <= 0) {
                    secondsLeft = REFRESH_INTERVAL;
                }
            }, 1000);
        }

        function updateTable(data) {
            const tbody = document.getElementById('bookBody');
            const statsBody = document.getElementById('statsBody');
            tbody.innerHTML = '';
            statsBody.innerHTML = '';

            // Update book table
            data.book.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.Symbol || '-'}</td>
                    <td>${formatDateTime(item.LongTimestamp)}</td>
                    <td>${formatNumber(item.BidSize1)}</td>
                    <td>${formatNumber(item.BidPrice1)}</td>
                    <td>${formatNumber(item.AskPrice1)}</td>
                    <td>${formatNumber(item.AskSize1)}</td>
                    <td>${item.HostName || '-'}</td>
                    <td>${item.ReadFrom || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            // Update stats table
            data.stat.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.server || '-'}</td>
                    <td>${formatNumber(stat.row_count)}</td>
                    <td>${stat.min_date || '-'}</td>
                    <td>${stat.max_date || '-'}</td>
                `;
                statsBody.appendChild(row);
            });

            const lastUpdateEl = document.querySelector('.last-update');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = `Last updated: ${formatDateTime(Date.now())}`;
            }

            startCountdown();
        }

        async function fetchOrderBook() {
            const loadingEl = document.querySelector('.loading');
            const errorEl = document.querySelector('.error');

            if (loadingEl) {
                loadingEl.style.display = 'inline';
            }
            if (errorEl) {
                errorEl.textContent = '';
            }

            try {
                const response = await fetch('https://mkt-data-server.chenfei-demo.com/cn_stock/book');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateTable(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                if (errorEl) {
                    errorEl.textContent = `Error: ${error.message}`;
                }
            } finally {
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }
        }

        // Initial fetch
        fetchOrderBook();

        // Set up auto-refresh
        autoRefreshInterval = setInterval(fetchOrderBook, REFRESH_INTERVAL * 1000);

        // Info box toggle functionality
        document.querySelector('.info-header').addEventListener('click', function() {
            const content = document.querySelector('.info-content');
            const icon = document.querySelector('.toggle-icon');
            content.classList.toggle('show');
            icon.classList.toggle('rotated');
        });
    </script>
</body>
</html>